{% load static %}
{% block content %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Graphique TempÃ©rature</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{% static 'DHT/graph_temp.css' %}">
    <style>
/* =========================
   GLOBAL
========================= */
body {
    font-family: Arial, sans-serif;
    background: #fafafa;
    margin: 0;
    padding: 20px;
}

/* =========================
   BUTTONS (MODERN & EQUAL)
========================= */
.btn {
    padding: 12px 28px;
    font-size: 15px;
    font-weight: 600;
    border: none;
    border-radius: 30px;
    cursor: pointer;
    color: #ffffff;

    display: inline-flex;
    align-items: center;
    justify-content: center;

    min-height: 44px;
    min-width: 220px;   /* ðŸ‘ˆ Ø¨Ø§Ø´ ÙŠÙƒÙˆÙ†Ùˆ Ù‚Ø¯ Ù‚Ø¯ */
    
    gap: 8px;
    transition: all 0.3s ease;
    box-shadow: 0 6px 14px rgba(0, 0, 0, 0.15);
}

/* Dashboard button */
.btn-dashboard {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
}

.btn-dashboard:hover {
    background: linear-gradient(135deg, #1e40af, #1e3a8a);
    transform: translateY(-2px);
    box-shadow: 0 10px 18px rgba(37, 99, 235, 0.4);
}

/* Download button */
.btn-download {
    background: linear-gradient(135deg, #22c55e, #16a34a);
}

.btn-download:hover {
    background: linear-gradient(135deg, #15803d, #166534);
    transform: translateY(-2px);
    box-shadow: 0 10px 18px rgba(34, 197, 94, 0.4);
}

/* =========================
   GRAPH CONTAINER
========================= */
.graph-container {
    width: 100%;
    max-width: 650px;
    margin: auto;
    background: #ffffff;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 0 12px rgba(0, 0, 0, 0.1);
}

.graph-container h2 {
    text-align: center;
    margin-bottom: 15px;
    color: #1e293b;
}

/* =========================
   CANVAS
========================= */
.canvas-wrapper {
    width: 100%;
    height: 260px;
    position: relative;
}

canvas {
    width: 100% !important;
    height: 100% !important;
}

/* =========================
   BUTTONS CONTAINER
========================= */
.buttons-container {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 20px;
}

/* =========================
   RESPONSIVE
========================= */
@media (max-width: 600px) {
    .btn {
        width: 100%;
        min-width: unset;
    }

    .buttons-container {
        flex-direction: column;
        align-items: center;
    }
}
    </style>
</head>
<body>

<div style="text-align: center; margin-bottom: 20px;">
    <button id="dashboardBtn" class="btn btn-dashboard">Retour au Dashboard</button>
    <button id="downloadDataBtn" class="btn btn-download">TÃ©lÃ©charger les donnÃ©es</button>
</div>

<div class="graph-container">
    <h2>TempÃ©rature â€” Historique</h2>
    <div class="canvas-wrapper">
        <canvas id="tempChart"></canvas>
    </div>
</div>

<script>
    // Redirection vers le Dashboard
    document.getElementById('dashboardBtn').addEventListener('click', () => {
        window.location.href = "{% url 'dashboard' %}";
    });

    // TÃ©lÃ©charger les donnÃ©es TempÃ©rature
    document.getElementById('downloadDataBtn').addEventListener('click', async () => {
        try {
            const response = await fetch('/api/history/');
            const data = await response.json();

            const mesures = data.history;

            if (!Array.isArray(mesures) || mesures.length === 0) {
                alert("Aucune donnÃ©e Ã  tÃ©lÃ©charger !");
                return;
            }

            // Ajouter BOM UTF-8 pour Excel
            let csvContent = "data:text/csv;charset=utf-8,\ufeff";
            csvContent += "Timestamp,TempÃ©rature,HumiditÃ©\n";

            mesures.forEach(item => {
                const ts = item.dt || "N/A";
                const temp = item.temp || "N/A";
                const hum = item.hum || "N/A";
                csvContent += `${ts},${temp},${hum}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "mesures_temperature.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

        } catch (err) {
            console.error("Erreur tÃ©lÃ©chargement :", err);
            alert("Erreur lors du tÃ©lÃ©chargement. VÃ©rifie la console.");
        }
    });
</script>
<script>let tempChartInstance;

async function drawTemp() {
    const res = await fetch("/api/history/?t=" + Date.now());
    const data = await res.json();
    const raw = data.history;

    if (!raw || raw.length === 0) {
        console.log("No temperature data");
        return;
    }

    raw.sort((a, b) => new Date(a.dt) - new Date(b.dt));

    const labels = raw.map(item =>
        new Date(item.dt).toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit"
        })
    );

    const temps = raw.map(item => item.temp);

    const canvas = document.getElementById("tempChart");
    if (!canvas) {
        console.error("Canvas tempChart not found");
        return;
    }

    const ctx = canvas.getContext("2d");

    if (tempChartInstance) {
        tempChartInstance.destroy();
    }

    const gradient = ctx.createLinearGradient(0, 0, 0, 260);
    gradient.addColorStop(0, "rgba(255,0,0,0.5)");
    gradient.addColorStop(1, "rgba(255,0,0,0)");

    tempChartInstance = new Chart(ctx, {
        type: "line",
        data: {
            labels: labels,
            datasets: [{
                label: "TempÃ©rature (Â°C)",
                data: temps,
                borderColor: "red",
                backgroundColor: gradient,
                borderWidth: 2,
                fill: true,
                tension: 0.35,
                pointRadius: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

drawTemp();

</script>
</body>
</html>
{% endblock %}