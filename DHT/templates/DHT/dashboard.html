{% load static %}
{% block content %}

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DHT11 Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
 <style>
    body {
        font-family: 'Inter', Arial, sans-serif;
        background: #f0f2f5;
        margin: 0;
        padding: 0;
    }

    .container {
        max-width: 900px;
        margin: 30px auto;
        padding: 0 18px;
    }

    .dashboard-card {
        background: #fff;
        border-radius: 18px;
        padding: 28px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.07);
        border: 1px solid #e6e9ef;
    }

    h1 {
        text-align: center;
        margin-bottom: 26px;
        font-size: 26px;
        color: #1d1d1f;
        font-weight: 700;
        letter-spacing: -0.5px;
    }

    /* Cards */
    .cards {
        display: flex;
        gap: 90px;
        justify-content: center;
        margin-bottom: 25px;
        flex-wrap: wrap;
    }

    .card {
        background: #fff;
        border-radius: 14px;
        padding: 22px;
        width: 210px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        border: 1px solid #ececec;
        transition: 0.25s ease;
    }
.btn-dashboard {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
}

.btn-dashboard:hover {
    background: linear-gradient(135deg, #1e40af, #1e3a8a);
    transform: translateY(-2px);
    box-shadow: 0 10px 18px rgba(37, 99, 235, 0.4);
}

    .card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        transform: translateY(-4px);
    }

    .card-header h3 {
        font-size: 17px;
        margin-bottom: 10px;
        color: #0a66c2;
        font-weight: 600;
    }

    .card span.value {
        font-size: 36px;
        font-weight: 700;
        color: #222;
    }

    .card span.time {
        font-size: 13px;
        color: #777;
    }

    /* Links */
    a {
        margin-top: 10px;
        color: #0a66c2;
        font-weight: 500;
        text-decoration: none;
    }

    a:hover {
        text-decoration: underline;
    }

    /* Buttons */
    .alert-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 22px;
    }

    .alert-buttons button {
        padding: 11px 26px;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        color: white;
        letter-spacing: 0.3px;
        transition: 0.25s ease;
    }

    #sendEmailBtn {
        background: linear-gradient(135deg, #ff6b6b, #ff4c4c);
    }

    #sendEmailBtn:hover {
        opacity: 0.9;
    }

    #sendTelegramBtn {
        background: linear-gradient(135deg, #4db8ff, #1a90ff);
    }

    #sendTelegramBtn:hover {
        opacity: 0.9;
    }

     #sendWhatsappBtn {
        background: linear-gradient(135deg, #99e59c, #4caf50);
    }

    #sendWhatsappBtn:hover {
        opacity: 0.9;
    }


    /* Alert box */
    #alertMessage {
        background: #4caf50 !important;
        padding: 14px 22px;
        border-radius: 10px;
        font-size: 15px;
        max-width: 400px;
        margin: 0 auto 25px;
        color: #fff;
        font-weight: 600;
        text-align: center;
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    .role-btn.dashboard {
    background: linear-gradient(135deg, #f59e0b, #fbbf24);
    border: none;
    color: white;
}

.role-btn.dashboard:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(251,191,36,0.35);
}

.role-btn.dashboard.active {
    box-shadow: 0 0 0 3px #facc15;
}
.dashboard-actions {
    display: flex;
    justify-content: center;
    margin-bottom: 25px;
    
}
.homeBtn {
    padding: 12px 32px;
    font-size: 15px;
    font-weight: 600;
    border: none;
    border-radius: 30px;
    cursor: pointer;
    color: #ffffff;

    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;

    min-height: 46px;
    min-width: 230px;

    transition: all 0.3s ease;
    box-shadow: 0 6px 14px rgba(0, 0, 0, 0.15);
}

.homeBtn:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 24px rgba(37, 99, 235, 0.35);
}

.homeBtn:active {
    transform: scale(0.98);
}

.homeBtn {
    padding: 12px 28px;
    font-size: 15px;
    font-weight: 600;
    border: none;
    border-radius: 30px;
    cursor: pointer;
    color: #ffffff;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-height: 44px;
    min-width: 220px;
    gap: 8px;
    transition: all 0.3s ease;
    box-shadow: 0 6px 14px rgba(0, 0,
    0, 0.15);
}
</style>

</head>

<body>
  


  <div class="container">
    <div class="dashboard-card">

      <h1>Dashboard Temp√©rature & Humidit√© (DHT11)</h1>

      <!-- Alerte -->
      {% if messages %}
      <div id="alertMessage">
        {% for message in messages %}
          {{ message }}
        {% endfor %}
      </div>

      <script>
        setTimeout(() => {
          const alertDiv = document.getElementById('alertMessage');
          if(alertDiv) alertDiv.style.opacity = 0;
          setTimeout(() => alertDiv?.remove(), 500);
        }, 10000);
      </script>
      {% endif %}

      <!-- Boutons -->


      <!-- Cartes Temp√©rature et Humidit√© -->
      <div class="cards">
        <div class="card temp-card">
          <div class="card-header"><h3>Temp√©rature</h3></div>
          <span class="value" id="lastTemp">-- ¬∞C</span>
          <span class="time" id="temp_time">-- sec</span>
          <a href="/graph/temp/">üå° Voir graphe</a>
        </div>

        <div class="card hum-card">
          <div class="card-header"><h3>Humidit√©</h3></div>
          <span class="value" id="lastHum">-- %</span>
          <span class="time" id="hum_time">-- sec</span>
          <a href="/graph/hum/">üíß Voir graphe</a>
        </div>
      </div>
        <div class="alert-buttons">
<button id="sendEmailBtn">üìß Envoyer Email</button>
<button id="sendTelegramBtn">üì® Envoyer Telegram</button>
            <audio id="alertSound" src="{% static 'DHT/sounds/alert.mp3' %}" preload="auto" loop></audio>
            <button id="stopAlertBtn" style="display:none; padding:10px 20px; background:#f44336; color:white; border:none; border-radius:5px; cursor:pointer;">
                üîï Arr√™ter l'alerte
            </button>
            <!-- <button id="sendWhatsappBtn">Envoyer WhatsApp</button> -->
        </div>
    {% if open_incidents > 0 %}
    <span style="
        background:red;
        color:white;
        padding:3px 8px;
        border-radius:8px;
        font-size:14px;
        font-weight:bold;">
        {{ open_incidents }}
    </span>
    {% endif %}
</a>

<div class="dashboard-actions">
    <button id="homeBtn" class="btn-dashboard homeBtn">
        üè† Retour √† l‚Äôaccueil
    </button>
</div>

    </div>

  </div>
<script>
document.getElementById("sendEmailBtn").addEventListener("click", () => {
    window.location.href = "{% url 'send_email_alert' %}";
});
document.getElementById("sendTelegramBtn").addEventListener("click", () => {
    window.location.href = "{% url 'send_telegram_alert' %}";
});
</script>

<script>
  
  async function loadLatest() {
    try {
      const response = await fetch("/api/latest/");
      const data = await response.json();

      document.getElementById("lastTemp").textContent = data.temperature + " ¬∞C";
      document.getElementById("lastHum").textContent = data.humidity + " %";

      const lastUpdate = new Date(data.timestamp);
      const now = new Date();
      const diffSec = Math.floor((now - lastUpdate) / 1000);

      // Format hh:mm:ss
      const hh = lastUpdate.getHours().toString().padStart(2, '0');
      const mm = lastUpdate.getMinutes().toString().padStart(2, '0');
      const ss = lastUpdate.getSeconds().toString().padStart(2, '0');
      const timeString = `${hh}:${mm}`;

      document.getElementById("temp_time").textContent = `il y a : ${diffSec} sec (${timeString})`;
      document.getElementById("hum_time").textContent = `il y a : ${diffSec} sec (${timeString})`;

    } catch (error) {
      console.error("Erreur loadLatest :", error);
    }
  }

  setInterval(loadLatest, 5000);
  loadLatest();
  if (data.temp > SEUIL_TEMPERATURE)
{  // Remplace SEUIL_TEMPERATURE par la valeur
    const audio = document.getElementById('alertSound');
    audio.play();  // Joue le son
}

</script>
<script src="{% static 'DHT/alert_sound.js' %}"></script>

<script>const SEUIL_TEMPERATURE = 20;
const audio = document.getElementById('alertSound');
const stopBtn = document.getElementById('stopAlertBtn');
let alertActive = false;
let userStopped = false; // <-- nouveau flag

async function checkAlert() {
    try {
        const response = await fetch("/api/latest/");
        const data = await response.json();

        if (data.temperature > SEUIL_TEMPERATURE) {
            if (!alertActive && !userStopped) { // ne joue que si pas stopp√© par user
                audio.play();
                alertActive = true;
                stopBtn.style.display = 'inline-block';
            }
        } else {
            if (alertActive) {
                audio.pause();
                audio.currentTime = 0;
                alertActive = false;
                stopBtn.style.display = 'none';
                userStopped = false; // reset si temp√©rature redescend
            }
        }

    } catch (error) {
        console.error("Erreur checkAlert:", error);
    }
}

setInterval(checkAlert, 5000);
checkAlert();

stopBtn.addEventListener('click', () => {
    audio.pause();
    audio.currentTime = 0;
    alertActive = false;
    userStopped = true; // bloque le son m√™me si temp√©rature > seuil
    stopBtn.style.display = 'none';
});

document.getElementById("sendWhatsappBtn").addEventListener("click", async () => {
    try {
        const response = await fetch("/send-whatsapp-alert/");
        const data = await response.json();

        if(data.status === "sent") {
            alert("WhatsApp envoy√© !");
        } else {
            alert("Erreur WhatsApp: " + data.error);
        }
    } catch(e) {
        alert("Erreur serveur !");
    }
});


</script>
<script>
    document.getElementById("homeBtn").addEventListener("click", () => {
        window.location.href = "{% url 'home' %}";
    });
</script>


</body>
</html>
{% endblock %}
